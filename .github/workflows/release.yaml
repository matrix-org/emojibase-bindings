name: Release Automation

on:
  workflow_dispatch:
    inputs:
      version-bump:
        description: The scale of the version bump required for semver compatibility
        required: true
        default: patch
        type: choice
        options:
          - patch
          - minor
          - major
concurrency: release

env:
  GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx4096m -Dfile.encoding=UTF-8 -XX:+HeapDumpOnOutOfMemoryError" -Dkotlin.daemon.jvm.options="-Xmx2560m" -Dkotlin.incremental=false
  CI_GRADLE_ARG_PROPERTIES: --stacktrace -PpreDexEnable=false --max-workers 4 --no-daemon
  ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
  ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
  ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.ANDROID_SIGNING_GPG }}
  ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.ANDROID_SIGNING_KEY_ID }}
  ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.ANDROID_SIGNING_KEY_PASSWORD }}
jobs:
  release:
    name: Release Bindings for Kotlin, Swift & Typescript
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§® Checkout code
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3
        with:
          fetch-depth: 0
          token: ${{ secrets.ELEMENT_BOT_TOKEN }}

      - uses: actions/setup-node@3235b876344d2a9aa001b8d1453c930bba69e610 # v3
        with:
          cache: "yarn"

      - name: ğŸ—œï¸ Setup
        run: "./scripts/setup.sh"

      - name: ğŸ”¨ Generate json
        run: "./scripts/generateJson.sh"

      - name: ğŸ‘Š Bump yarn version
        run: |
          yarn version --no-git-tag-version --${{ github.event.inputs.version-bump }}

      - name: ğŸ‘Š Set the version in env
        run: |
          echo "NEW_VERSION=$(cat package.json | jq -r .version)" >> $GITHUB_ENV

      - name: ğŸ‘Š Sync the version with android
        run: |
          ./scripts/update_android_version.sh ${{ env.NEW_VERSION }}

      - name: ğŸ‘Š Commit the version
        run: |
          git config --global user.name 'ElementRobot'
          git config --global user.email 'releases@riot.im'
          git commit -am "${{ github.event.inputs.version-bump }} version bump"
          git push

      - name: ğŸ› ï¸ Setup Java
        uses: actions/setup-java@17f84c3641ba7b8f6deff6309fc4c864478f5d62 # v3
        with:
          distribution: 'adopt'
          java-version: '21'

      - name: â¬†ï¸ Publish to Maven Central
        uses: gradle/gradle-build-action@ac2d340dc04d9e1113182899e983b5400c17cda1 # v3
        with:
          build-root-directory: platforms/android
          arguments: publishAllPublicationsToMavenCentral
      - name: ğŸš€ Close staging repo and release version
        uses: gradle/gradle-build-action@ac2d340dc04d9e1113182899e983b5400c17cda1 # v3
        with:
          build-root-directory: platforms/android
          arguments: publishAndReleaseToMavenCentral

      - name: ğŸš€ Publish to npm
        id: npm-publish
        uses: JS-DevTools/npm-publish@5a85faf05d2ade2d5b6682bfe5359915d5159c6c # v2.2.1
        with:
          token: ${{ secrets.NPM_TOKEN }}
          access: public
          ignore-scripts: false

      - name: ğŸ§¬ Create release
        uses: actions/create-release@0cb9c9b65d5d1901c1f53e5e66eaf4afd303e70e # v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.NEW_VERSION }}
          release_name: Release ${{ env.NEW_VERSION }}
          body: ${{ env.NEW_VERSION }} Release
          draft: false
          prerelease: false
